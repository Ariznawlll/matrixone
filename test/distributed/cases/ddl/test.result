drop database if exists test;
create database test;
use test;
drop table if exists retention01;
create table retention01 (col1 int auto_increment, col2 decimal) with retention period 5 second;
insert into retention01 values (1, 2);
insert into retention01 values (2, 100);
insert into retention01 values (3, null);
select * from retention01;
col1    col2
1    2
2    100
3    null
select * from mo_catalog.mo_retention;
database_name    table_name    retention_deadline
test    retention01    1725952294
select sleep(5);
sleep(5)
0
select mo_ctl('cn', 'task', ':retention');
mo_ctl(cn, task, :retention)
{\n  "method": "TASK",\n  "result": {\n    "RequestID": 14,\n    "CmdMethod": 13,\n    "RunTask": {\n      "Result": "OK"\n    },\n    "GetReplicaCount": {},\n    "GoMaxProcsResponse": {},\n    "GoMemLimitResponse": {},\n    "FileServiceCacheResponse": {},\n    "FileServiceCacheEvictResponse": {}\n  }\n}\n
select sleep(1);
sleep(1)
0
show tables;
Tables_in_test
select * from retention01;
SQL parser error: table "retention01" does not exist
drop table retention01;
no such table test.retention01
drop table if exists retention02;
create table retention02(col1 int primary key , col2 decimal, col3 char, col4 varchar(20), col5 text, col6 double) with retention period 3 second;
insert into retention02 values (1, 2, 'a', '23eiojf', 'r23v324r23rer', 3923.324);
insert into retention02 values (2, 3, 'b', '32r32r', 'database', 1111111);
select * from mo_catalog.mo_retention;
database_name    table_name    retention_deadline
test    retention02    1725952298
select sleep(3);
sleep(3)
0
select mo_ctl('cn', 'task', ':retention');
mo_ctl(cn, task, :retention)
{\n  "method": "TASK",\n  "result": {\n    "RequestID": 15,\n    "CmdMethod": 13,\n    "RunTask": {\n      "Result": "OK"\n    },\n    "GetReplicaCount": {},\n    "GoMaxProcsResponse": {},\n    "GoMemLimitResponse": {},\n    "FileServiceCacheResponse": {},\n    "FileServiceCacheEvictResponse": {}\n  }\n}\n
select sleep(1);
sleep(1)
0
select * from mo_catalog.mo_retention;
database_name    table_name    retention_deadline
drop table if exists retention02;
drop table if exists retention03;
create table retention03 (
emp_no      int             not null,
birth_date  date            not null,
first_name  varchar(14)     not null,
last_name   varchar(16)     not null,
gender      varchar(5)      not null,
hire_date   date            not null,
primary key (emp_no)
) with retention period 10 second
partition by range columns (emp_no)(
partition p01 values less than (100001),
partition p02 values less than (200001),
partition p03 values less than (300001),
partition p04 values less than (400001)
);
insert into retention03 values (9001,'1980-12-17', 'SMITH', 'CLERK', 'F', '2008-12-17'),
(9002,'1981-02-20', 'ALLEN', 'SALESMAN', 'F', '2008-02-20');
select * from mo_catalog.mo_retention;
database_name    table_name    retention_deadline
test    retention03    1725952309
drop table retention03;
select * from mo_catalog.mo_retention;
database_name    table_name    retention_deadline
show tables;
Tables_in_test
drop table if exists retention04;
create table retention04 (
id int primary key ,
order_number varchar(20),
status enum('Pending', 'Processing', 'Completed', 'Cancelled')
) with retention period 5 second;
insert into retention04 values(1,'111',1),(2,'222',2),(3,'333',3),(4,'444','Cancelled');
select * from mo_catalog.mo_retention;
database_name    table_name    retention_deadline
test    retention04    1725952304
drop database test;
select * from mo_catalog.mo_retention;
database_name    table_name    retention_deadline
use mo_catalog;
drop table if exists retention05;
create cluster table retention05 (a int) with retention period 3 second;
insert into retention05 values(0, 0),(1, 0),(2, 0),(3, 0);
insert into retention05 values(0, 1),(1, 1),(2, 1),(3, 1);
select * from mo_catalog.mo_retention;
database_name    table_name    retention_deadline
mo_catalog    retention05    1725952302
select sleep(3);
sleep(3)
0
select mo_ctl('cn', 'task', ':retention');
mo_ctl(cn, task, :retention)
{\n  "method": "TASK",\n  "result": {\n    "RequestID": 16,\n    "CmdMethod": 13,\n    "RunTask": {\n      "Result": "OK"\n    },\n    "GetReplicaCount": {},\n    "GoMaxProcsResponse": {},\n    "GoMemLimitResponse": {},\n    "FileServiceCacheResponse": {},\n    "FileServiceCacheEvictResponse": {}\n  }\n}\n
select sleep(1);
sleep(1)
0
select * from mo_catalog.mo_retention;
database_name    table_name    retention_deadline
drop database if exists test01;
create database test01;
use test01;
drop table if exists retention06;
create table retention06 (col1 int, col2 decimal(6), col3 varchar(30)) with retention period 1 second;
insert into retention06 values (1, null, 'database');
insert into retention06 values (2, 38291.32132, 'database');
insert into retention06 values (3, null, 'database management system');
select count(*) from retention06;
count(*)
3
show create table retention06;
Table    Create Table
retention06    CREATE TABLE `retention06` (\n  `col1` int DEFAULT NULL,\n  `col2` decimal(6,0) DEFAULT NULL,\n  `col3` varchar(30) DEFAULT NULL\n)
drop view if exists v01;
create view v01 as select * from retention06;
select * from v01;
col1    col2    col3
1    null    database
2    38291    database
3    null    database management system
select * from mo_catalog.mo_retention;
database_name    table_name    retention_deadline
test01    retention06    1725952305
select sleep(2);
sleep(2)
0
select mo_ctl('cn', 'task', ':retention');
mo_ctl(cn, task, :retention)
{\n  "method": "TASK",\n  "result": {\n    "RequestID": 17,\n    "CmdMethod": 13,\n    "RunTask": {\n      "Result": "OK"\n    },\n    "GetReplicaCount": {},\n    "GoMaxProcsResponse": {},\n    "GoMemLimitResponse": {},\n    "FileServiceCacheResponse": {},\n    "FileServiceCacheEvictResponse": {}\n  }\n}\n
select sleep(2);
sleep(2)
0
select * from mo_catalog.mo_retention;
database_name    table_name    retention_deadline
show tables;
Tables_in_test01
v01
select * from v01;
SQL parser error: table "retention06" does not exist
drop view v01;
drop table if exists retention08;
create table retention08(t1 time,t2 time,t3 time) with retention period 1 second;
insert into retention08 values("-838:59:59.0000","838:59:59.00","22:00:00");
insert into retention08 values("0:00:00.0000","0","0:00");
insert into retention08 values(null,NULL,null);
insert into retention08 values("23","1122","-1122");
drop table if exists retention09;
create table retention09(t1 time,t2 time,t3 time);
insert into retention09 select * from retention08;
select * from mo_catalog.mo_retention;
database_name    table_name    retention_deadline
test01    retention08    1725952309
select sleep(2);
sleep(2)
0
select mo_ctl('cn', 'task', ':retention');
mo_ctl(cn, task, :retention)
{\n  "method": "TASK",\n  "result": {\n    "RequestID": 18,\n    "CmdMethod": 13,\n    "RunTask": {\n      "Result": "OK"\n    },\n    "GetReplicaCount": {},\n    "GoMaxProcsResponse": {},\n    "GoMemLimitResponse": {},\n    "FileServiceCacheResponse": {},\n    "FileServiceCacheEvictResponse": {}\n  }\n}\n
select sleep(2);
sleep(2)
0
select * from mo_catalog.mo_retention;
database_name    table_name    retention_deadline
show tables;
Tables_in_test01
retention09
select * from retention08;
SQL parser error: table "retention08" does not exist
select * from retention09;
t1    t2    t3
-838:59:59    838:59:59    22:00:00
00:00:00    00:00:00    00:00:00
null    null    null
00:00:23    00:11:22    00:11:22
drop table retention09;
drop table if exists aff01;

drop table if exists pri01;

create table pri01(a int primary key, b int unique key) with retention period 2 second;

create table aff01 (a int, b int, foreign key f_a(a) references pri01(a));

insert into pri01 values (1,1), (2,2), (3,3);

insert into aff01 values (1,1), (2,2), (3,3);

select * from mo_catalog.mo_retention;

select sleep(2);

select mo_ctl('cn', 'task', ':retention');

select sleep(1);

select * from mo_catalog.mo_retention;

show tables;

drop table if exists aff01;
drop table if exists pri01;
create table pri01(a int primary key, b int unique key);
create table aff01 (a int, b int, foreign key f_a(a) references pri01(a))  with retention period 2 second;
insert into pri01 values (1,1), (2,2), (3,3);
insert into aff01 values (1,1), (2,2), (3,3);
select * from mo_catalog.mo_retention;
database_name    table_name    retention_deadline
test01    aff01    1725952314
select sleep(2);
sleep(2)
0
select mo_ctl('cn', 'task', ':retention');
mo_ctl(cn, task, :retention)
{\n  "method": "TASK",\n  "result": {\n    "RequestID": 19,\n    "CmdMethod": 13,\n    "RunTask": {\n      "Result": "OK"\n    },\n    "GetReplicaCount": {},\n    "GoMaxProcsResponse": {},\n    "GoMemLimitResponse": {},\n    "FileServiceCacheResponse": {},\n    "FileServiceCacheEvictResponse": {}\n  }\n}\n
select sleep(1);
sleep(1)
0
select * from mo_catalog.mo_retention;
database_name    table_name    retention_deadline
show tables;
Tables_in_test01
pri01
select * from pri01;
a    b
1    1
2    2
3    3
drop table pri01;
